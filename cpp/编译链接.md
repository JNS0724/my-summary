# 编译链接

## ELF

Executable and Linking Format可执行文件格式

## 链接过程

1.地址与空间分配

目标文件合并: 相似段合并, 比如代码段和代码段合并.

链接器会收集输入目标文件中的符号定义和引用,形成全局的符号表,同时计算每个段的地址.

2.符号解析

3.重定位

## 动态链接

<https://github.com/iqiyi/xHook/blob/master/docs/overview/android_plt_hook_overview.zh-CN.md>

### GOT Global Offset Table

全局偏移表

存储着外部符号的实际地址偏移量

存在的原因是, 动态链接时,不能直接修改代码段,只能在数据段生成这样的一张表,等查到符号的相对地址后回写到此表中,根据地址去计算实际的外部符号的地址.

elf对got做了细分：got存放全局变量引用的地址，got.plt存放函数引用的地址

### PLT Procedure Link Table

程序链接表

实现延迟绑定的机制,plt存储的是代码片段,用来跳转到可以帮助我们寻址的_dl_runtime_resolve.

有两个功能

1. 从.got.plt中得到地址,并跳转
2. 触发链接器找到所需地址.

动态库函数第一次调用:xxx@plt -> xxx@got.plt(由于第一次访问,存储地址的是跳转回来) -> common@plt -> _dl_runtime_resolve 做地址解析.

然后将地址回写到GOT中,并返回地址回到调用处.

## 堆栈帧

* 函数的返回地址和参数
* 临时变量,非静态局部变量和编译器生成的其他临时变量
* 保存的上下文,函数前后保持不变的寄存器
