# buffer

## doublewrite buffer

mysql一个数据页是16k，操作系统是4k，16k会分四次持久化。如果写入一半时崩溃，就会有页断裂的风险。

bufferpool中的2MB内存，128个16k数据页。对应了共享表空间中的2MB磁盘空间。

脏页刷新的时候，会选择先写道doublewrite buffer中。

第1步：页数据先memcopy到DWB的内存里；

第2步：DWB的内存里的数据页，会先刷到DWB的磁盘上，顺序追加。8.0后可以指定存放目录，更快刷盘。

第3步：DWB的内存里的数据页，再刷到数据磁盘存储.ibd文件上。

如果系统的保证16k数据页的原子写入，可以不需要doublewrite，提升性能。

### 为什么redolog不能恢复页断裂

redolog在崩溃恢复时，通过比较页中的LSN和自身的LSN来判断是新是旧，旧的才会重放。当页写入一半时，可能LSN信息改变但是数据没有刷新完。

除非每次重放都重放一个完整的事务。