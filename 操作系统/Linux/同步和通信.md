# 并发

## System V

Unix操作系统在操作风格上主要分为System V和BSD。System V它最初由AT&T开发，曾经也被称为AT&T System V，是Unix操作系统众多版本中的一支。

## posix

Posix是Portable Operating System Interface(可移植性操作系统接口)的简称，是一个电气与电子工程学会即IEEE开发的一系列标准，目的是为运行在不同操作系统的应用程序提供统一的接口，实现者是不同的操作系统内核。

将这两个名词放在一起讨论的一般是在Linux的进程间通信中，如在信号量编程中，有Posix信号量和System V信号量。它们都可以用于进程或者线程间的同步。

然而，Posix信号量是基于内存的，即信号量值是放在共享内存中的，它使与文件系统中的路径名对应的名字来标识。当我们谈论“Posix 信号量”时，所指的是单个计数信号量。

System v信号量基于内核的，它放在内核里面，要使用System V信号量需要进入内核态，所以在多线程编程中一般不建议使用System V信号量，因为线程相对于进程是轻量级的，从操作系统的调度开销角度看，如果使用System V信号量会使得每次调用都要进入内核态，丧失了线程的轻量优势。当我们讨论“System v信号量”时，所指的是计数信号量集。

## 进程间通信

### Unix ipc

* 管道

    匿名管道：父子兄弟进程通信
    命名管道：不想关的进程也可以通信
* 信号
    用于通知接收进程某个事件已经发生。

### System ipc

* 消息队列
* 信号量
* 共享内存

### Posix ipc

* 消息队列
* 信号量

    计数器

* 共享内存

    共享内存就是映射一段能被其他进程所访问的内存，这段共享内存由一个进程创建，但多个进程都可以访问。

## 进程间同步

* 原子操作

原子操作与硬件架构强相关，通过汇编实现。

* 信号量（semaphore）

    基于spinlock实现
* 读写信号量（rw_semaphore）
* Spinlock

    spin_lock用于阻止在不同CPU上的执行单元对共享资源的同时访问以及不同进程上下文互相抢占导致的对共享资源的非同步访问，而中断失效（spin_lock_irq）和软中断失效(spin_lock_bh)却是为了阻止在同一CPU上软中断或中断对共享资源的非同步访问。
* Mutex
    基于spinlock实现
* Rwlock

## 共享内存

主流的方式：

* 传统的System V
* 基于Posix mmap文件映射实现
* 通过memfd_create和fd跨进程实现
* 多媒体、图形领域使用基于dma_buf的共享内存

## futex

std::mutex底层是futex实现。

单核通过关中断实现原子性。

多核通过锁总线和缓存一致性协议。
