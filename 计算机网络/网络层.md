# 网络层

## 功能

网络层主要解决异构网络互联、路由转发、拥塞控制。

## 虚电路和数据报网络

数据报网络提供网络层的无连接服务。
虚电路网络提供网络层的连接服务。

## 主要协议

IP、ARP、ICMP、IGMP

## 路由转发

### 路由选择

根据特定路由选择协议构造出路由表定期和相邻的路由表交换信息，更新路由表。

### 分组转发

根据转发表将用户IP数据报转发到合适的端口。

## 拥塞控制

用户对网络资源（包括链路带宽、存储空间和处理器处理能力等）的总需求超过了网络固有的容量。
发生拥塞的原因：

* 缓冲区容量有限
* 传输线路的带宽有限
* 网络结点的处理能力有限
* 网络中某些部分发生了故障

### 流量感知路由

网络抽象为一张带权无向图， 路由器抽象为图的结点， 链路抽象为图的边，每一条链路有自己的链路费用（例如：时延小，权值小）。权值根据网络负载动态调整， 可以将网络流量引导到不同的链路上， 均衡网络负载。

### 准入控制

对新建虚电路审核，如果新建立的虚电路会导致网络变得拥塞，那么网络拒绝建立该新虚电路。

### 流量调节

流量调节：在网络发生拥塞时，通过调整发送方发送数据的速率来消除拥塞。
抑制分组：感知到拥塞的路由器选择一个被拥塞的数据报，给该数据报的源主机返回一个抑制分组。背压：抑制分组在从拥塞结点到源结点的路径上的每一跳，都发挥抑制作用。

### 负载脱落

负载脱落：有选择地主动丢弃一些数据报，来减轻网络负载，从而缓解或消除拥塞。

## IP协议

无连接的、不可靠的、尽力的数据报投递服务。每个数据链路上会规定一个最大传输单元MTU，如果 IP 数据报的长度超过 MTU，那么网络层就会把这些报文分割成一个一个的小组（分组）进行传送，以适应具体的传输网络。

### IP地址

| IP地址类别 | 网络号 | 网络范围 | 主机号 | IP地址范围 |
|---|---|---|---|---|
|A 类|8bit，第一位固定为 0|0 —— 127|24bit|1.0.0.0 —— 127.255.255.255|
|B 类|16bit，前两位固定为 10|128.0 —— 191.255|16bit|128.0.0.0 —— 191.255.255.255|
|C 类|24bit，前三位固定为 110|192.0.0 —— 223.255.255|8bit|192.0.0.0 —— 223.255.255.255|
|D 类|前四位固定为 1110，后面为多播地址|||
|E 类|前五位固定为 11110，后面保留为今后所用|||

### 其他地址分类

* 网络号全0，但主机号非全0的某个ip就是指本网络的某个主机
* 网络号不为全1，但主机号全为1的ip，则指某个网络的广播地址
* 全0，指本网络的本主机
* 全1，指本网络的广播地址
* 环回地址，指127.0.0.1，在同一台主机上进行网络传输
* 私有地址，指不会参与路由器转发的地址,， 只会参与本局域网，发给本局域网的交换机：
* A类： 10.0.0.0-10.25.255.255
* B类： 172.16.0.0-172.31.0.0
* C类： 192.168.0.0-192.168.255.255

### CIDR

IP地址 ::= {<网络号>， <子网号>， <主机号>}

* 128.14.35.7/20 ， 完整ip加子网位数
* 10.0.0.0/10 -> 10/10， 可省略末尾的0
* 00010100*， 即用星号代替子网后的主机号

### 子网掩码

值1的位置指该ip中该位置是网络号和子网号区域
值0的位置指该ip中该位置是主机号区域。
路由寻址时，一般先比较网络号，再比较子网号，再比较主机。

### NAT

用于在本地网络中使用私有地址，在连接互联网时使转而使用全局 IP 地址的技术。实现网络地址转换的关键就在于 NAT 路由器。在 NAT 路由器的内部，有一张自动生成的用来转换地址的表。

### IP报文

* 20个字节的首部长度
* 分片和重组
    分片问题一般只存在于具有不同MTU值的互联网中，把一个数据报为了适合网络传输而分成多个数据报的过程称为分片，当分了片的IP数据报到达最终目标主机时，目标主机对各分片进行组装，恢复成源主机发送时的IP数据报。
* MTU：数据链路帧的数据区的最大字节数

## ARP协议

根据IP地址获得对方的MAC地址。

* 检查自身ARP缓存表
* 发送ARP request广播报文，ARP请求报文中的发送端IP地址和发送端MAC地址为主机A的IP地址和MAC地址，目标IP地址和目标MAC地址为主机B的IP地址和全0的MAC地址。
* 主机B以单播方式发送ARP响应报文给主机A，其中包含了自己的MAC地址。
* 主机A收到ARP响应报文后，将主机B的MAC地址加入到自己的ARP表中以用于后续报文的转发。
* 当主机A和主机B不在同一网段时，主机A就会先向网关发出ARP请求，然后把帧的目的mac地址改成网关的，把数据包发到网关。当网关解析到ip协议时，发现目的ip不是自己，就重新封装成帧，发到下一跳路由。

因此ARP协议是网络层协议，因为涉及到网络层路由转发到对应子网。

## ICMP协议

网络控制报文协议，封装在IP的数据报文中。
发送网络层之间的差错报告。

## DHCP协议

* 主机通过广播查找DHCP服务器。
* DCHP服务器收到后，会分配一个IP地址，并广播。
* 主机收到DHCP广播的报文后，单播DHCP服务器。
* DHCP回应主机，缓存主机信息。

DCHP可以认为是基于UDP的应用层协议，但本质是为了寻求新主机的动态ip地址。
