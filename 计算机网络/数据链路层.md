# 数据链路层

物理层构建了网络的物理通道，数据链路层在物理层的基础上，构建了逻辑链路。具体的如局域网中的以太网链路，广域网中的数据链路。
数据链路层提供差错检测和流量检测功能，将物理层的比特流解析成帧结构。
数据链路层屏蔽的物理介质的差异，提供具有协议约定的逻辑通道。
数据链路层的主体在网络适配器实现，

***协议主要有PPP协议、以太网的CSMA/CD协议、OSI的HDLC协议***。

## 信道类型

数据链路层使用的信道主要有两种类型：

* 点对点信道
* 广播信道

## 基本功能

### 链路管理

数据链路层有三种基本服务。

无确认的无连接服务，有确认的无连接服务，有确认的有连接服务。
链路管理主要是负责链路的建立，维护和释放。主要面向有连接的服务。

### 封装成帧

在帧的前后添加头部和尾部，界定帧的边界。MTU就是帧的数据部分的最大长度，也就是IP数据报的最大长度。
帧的作用主要在于对底层比特流数据的逻辑定义，并且提供***帧定界***功能

### 透明传输

透明传输是指数据链路层对上层交付的传输数据并没有任何限制，就好像数据链路层不存在一样

其主要解决的问题就是在帧数据中，包含了帧头或帧尾的信息，接收方该如何判别这是定界信息还是数据的问题。

* 字符计数法
    字符计数法是用一个特殊的字符来表示一帧的开始，然后用一个计数字段来表明该帧包含的字节数。
    很少看到。
* 零比特填充法（HDLC协议、PPP协议）
    使用01111110作为帧的开始和结束标志，如果帧数据部分出现01111110（即连续的6个“1”），只要数据帧检测到有5个连续的“1”，马上在其后插入“0”
* 字符填充法
    SOH是帧首部的第一个标记开始的字节，EOT是帧尾部的结束字节，有了这两个字节，接收端就能够判断帧接收的开始位置和结束位置。
* 违规编码法
    在曼切斯特编码中，每一个比特对应的电频都是对应“高-低”或者“低-高”，不会出现“高-高”或者“低-低”这两种编码方式，因此这两种编码方式就是两种违规的编码方法。

### 差错校验

#### CRC循环冗余校验

根本思想就是先在要发送的帧后面附加一个数（这个数就是用来校验的校验码，也是二进制序列的），生成一个新帧发送给接收端。当然，这个附加的数不是随意的，它要使所生成的新帧能与发送端和接收端共同选定的某个特定数整除。

### 流量控制

在OSI中，数据链路层存在流量控制。而在TCP/IP中，数据链路层的流量控制，在传输层中进行。
数据链路层的流量控制方案主要有两种：一种是适用于面向字符的异步通信协议（如 RS-232) 中的简单流量控制方案 XON/XOFF (继续/停止)方案;另一种是适用于大量数据通信环境中的滑动窗口。

### 可靠传输

* 停止-等待协议SW

* 回退N帧协议GBN

* 选择重传协议SR

## 点对点协议

### HDLC协议

高级数据链路控制协议，在数据链路层上实现了***可靠传输***，牺牲了一定性能，在过去通信链路质量差的时候使用。

* 支持面向连接和面向无连接
* 支持点对点和点对多点
* 支持半双工和全双工
* 支持流量控制和差错控制
* HDLC的帧格式规定以01111110（十六进制7E）的位组合作为它的起始和结束的标志，用零比特填充法来实现透明传输。

### PPP协议

PPP (Point-to-Point Protocol，点对点协议）是一种应用非常广泛的广域网数据链路层协议。在以太网运行的PPP协议来进行用户认证和接入的称为PPPoE协议。

![PPP帧格式](/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/assets/PPP%E5%8D%8F%E8%AE%AE%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)

## 广播信道

主要用于局域网，局域网应用最广泛的就是我们熟悉的***以太网***。
以太网提供服务是不可靠的交付，即最大努力的交付；当接收站收到的有差错的数据帧时就丢弃此帧，其它什么也不做，差错的纠正由高层来处理；如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新帧发送。
以太网使用星型的网络拓扑结构，在星形的中心增加了一种可靠性高的设备，为集线器(hub)。

### CSMA/CD 协议

## 数据链路层主要网络设备

### 网卡

网卡是一块被设计用来允许计算机在计算机网络上进行通讯的计算机硬件。由于其拥有MAC地址，因此属于OSI模型的第1层和2层之间。它使得用户可以通过电缆或无线相互连接。
每一个网卡都有一个被称为MAC地址的独一无二的48位串行号，它被写在卡上的一块ROM中。在网络上的每一个计算机都必须拥有一个独一无二的MAC地址。

### 网桥

网桥（Bridge）是早期的两端口二层网络设备。网桥的两个端口分别有一条独立的交换信道，不是共享一条背板总线，可隔离冲突域。网桥比集线器（Hub）性能更好，集线器上各端口都是共享同一条背板总线的。后来，网桥被具有更多端口、同时也可隔离冲突域的交换机所取代。

网桥初期主要用于局域网LAN分段、传输距离延伸和增加应用设备，并使局域网突破共享网络带宽的限制。为了能够使局域网LAN满足当时的应用需求，需要扩展局域网系统。同时，为了使网络系统运行更可靠，把一个局域网系统划分为若干个独立的物理网段。实现物理网段之间的连接和扩展局域网系统的需求导致了网桥的发展。

### 交换机

交换机是主导网络系统的集线设备，大部分交换机是在OSI参考模型的数据链路层（第二层）操作。如果把集线器看成一条内置的以太网总线，交换机就可以看做由多条总线构成交换矩阵的互联系统。

### 交换机与网桥的区别

局域网交换机的基本功能与网桥一样，具有帧转发、帧过滤和生成树算法功能。但是，交换机与网桥相比还是存在以下不同：

* 交换机工作时，实际上允许许多组端口间的通道同时工作。所以，交换机的功能体现出不仅仅是一个网桥的功能，而是多个网桥功能的集合。即网桥一般分有两个端口，而交换机具有高密度的端口。

* 分段能力的区别

由于交换机能够支持多个端口，因此可以把网络系统划分成为更多的物理网段，这样使得整个网络系统具有更高的带宽。而网桥仅仅支持两个端口，所以，网桥划分的物理网段是相当有限的。

* 传输速率的区别

交换机与网桥数据信息的传输速率相比，交换机要快于网桥。

* 数据帧转发方式的区别

网桥在发送数据帧前，通常要接收到完整的数据帧并执行帧检测序列FCS后，才开始转发该数据帧。交换机具有存储转发和直接转发两种帧转发方式。直接转发方式在发送数据以前，不需要在接收完整个数据帧和经过32bit循环冗余校验码CRC的计算检查后的等待时间。

### Linux下的虚拟网桥

网桥是在内核中虚拟出来的，可以将主机上真实的物理网卡（如eth0，eth1），或虚拟的网卡（tap0,tap1,vnet0,vnet1)桥接上来。桥接上来的网卡就相当于网桥上的端口。 端口收到的数据包都提交给这个虚拟的”网桥“，让其进行转发。
